tinymce.PluginManager.add("link",function(t){function e(e){return function(){var n=t.settings.link_list;"string"==typeof n?tinymce.util.XHR.send({url:n,success:function(t){e(tinymce.util.JSON.parse(t))}}):e(n)}}function n(e){function n(t){var e=f.find("#text");(!e.value()||t.lastControl&&e.value()==t.lastControl.text())&&e.value(t.control.text()),f.find("#href").value(t.control.value())}function l(){var n=[{text:"None",value:""}];return tinymce.each(e,function(e){n.push({text:e.text||e.title,value:t.convertURL(e.value||e.url,"href"),menu:e.menu})}),n}function i(e){var n=[{text:"None",value:""}];return tinymce.each(t.settings.rel_list,function(t){n.push({text:t.text||t.title,value:t.value,selected:e===t.value})}),n}function o(e){var n=[{text:"None",value:""}];return t.settings.target_list||n.push({text:"New window",value:"_blank"}),tinymce.each(t.settings.target_list,function(t){n.push({text:t.text||t.title,value:t.value,selected:e===t.value})}),n}function a(e){var l=[];return tinymce.each(t.dom.select("a:not([href])"),function(t){var n=t.name||t.id;n&&l.push({text:n,value:"#"+n,selected:-1!=e.indexOf("#"+n)})}),l.length?(l.unshift({text:"None",value:""}),{name:"anchor",type:"listbox",label:"Anchors",values:l,onselect:n}):void 0}function r(){h&&h.value(t.convertURL(this.value(),"href")),c||0!==g.text.length||this.parent().parent().find("#text")[0].value(this.value())}var u,s,c,f,h,d,v,g={},x=t.selection,m=t.dom;u=x.getNode(),s=m.getParent(u,"a[href]"),g.text=c=s?s.innerText||s.textContent:x.getContent({format:"text"}),g.href=s?m.getAttrib(s,"href"):"",g.target=s?m.getAttrib(s,"target"):"",g.rel=s?m.getAttrib(s,"rel"):"","IMG"==u.nodeName&&(g.text=c=" "),e&&(h={type:"listbox",label:"Link list",values:l(),onselect:n,value:t.convertURL(g.href,"href"),onPostRender:function(){h=this}}),t.settings.target_list!==!1&&(v={name:"target",type:"listbox",label:"Target",values:o(g.target)}),t.settings.rel_list&&(d={name:"rel",type:"listbox",label:"Rel",values:i(g.rel)}),f=t.windowManager.open({title:"Insert link",data:g,body:[{name:"href",type:"filepicker",filetype:"file",size:40,autofocus:!0,label:"Url",onchange:r,onkeyup:r},{name:"text",type:"textbox",size:40,label:"Text to display",onchange:function(){g.text=this.value()}},a(g.href),h,d,v],onSubmit:function(e){function n(e,n){var l=t.selection.getRng();window.setTimeout(function(){t.windowManager.confirm(e,function(e){t.selection.setRng(l),n(e)})},0)}function l(){i.text!=c?s?(t.focus(),s.innerHTML=i.text,m.setAttribs(s,{href:o,target:i.target?i.target:null,rel:i.rel?i.rel:null}),x.select(s)):t.insertContent(m.createHTML("a",{href:o,target:i.target?i.target:null,rel:i.rel?i.rel:null},i.text)):t.execCommand("mceInsertLink",!1,{href:o,target:i.target,rel:i.rel?i.rel:null})}var i=e.data,o=i.href;return o?o.indexOf("@")>0&&-1==o.indexOf("//")&&-1==o.indexOf("mailto:")?(n("The URL you entered seems to be an email address. Do you want to add the required mailto: prefix?",function(t){t&&(o="mailto:"+o),l()}),void 0):/^\s*www\./i.test(o)?(n("The URL you entered seems to be an external link. Do you want to add the required http:// prefix?",function(t){t&&(o="http://"+o),l()}),void 0):(l(),void 0):(t.execCommand("unlink"),void 0)}});for(var k=f.find("*"),p=null,b=null,y=null,w=null,C=0;C<f.settings.buttons.length;C++)switch(f.settings.buttons[C].text.toLowerCase()){case"ok":y=f.settings.buttons[C];break;case"cancel":w=f.settings.buttons[C]}for(var L=0;L<k.length;L++)switch(k[L]._name){case"href":p=k[L],g.textarea=p;break;case"target":b=k[L]}setTimeout(function(){CE.Link.myThis.open(g,{title:!1},function(e){setTimeout(function(){p.value(e.href),b.value(e.target),y.onclick(),t.focus()},200)},function(){setTimeout(function(){CE.Link.wpLink.close(),w.onclick(),t.focus()},200)})},50)}t.addButton("link",{icon:"link",tooltip:"Insert/edit link",shortcut:"Ctrl+K",onclick:e(n),stateSelector:"a[href]"}),t.addButton("unlink",{icon:"unlink",tooltip:"Remove link",cmd:"unlink",stateSelector:"a[href]"}),t.addShortcut("Ctrl+K","",e(n)),this.showDialog=n,t.addMenuItem("link",{icon:"link",text:"Insert link",shortcut:"Ctrl+K",onclick:e(n),stateSelector:"a[href]",context:"insert",prependToContext:!0})});